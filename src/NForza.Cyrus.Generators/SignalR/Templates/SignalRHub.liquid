using System;
using System.Threading.Tasks;
using Microsoft.AspNetCore.SignalR;
using NForza.Cyrus.Cqrs;
using NForza.Cyrus.SignalR;
using Microsoft.Extensions.DependencyInjection;

namespace {{ Namespace }};

public class {{ Name | generated-hub-name }}(IQueryProcessor queryProcessor, ICommandDispatcher commandDispatcher) : CyrusHub
    (
      [
      {% for e in Events -%}
        (typeof({{ e.ClrTypeName }}), {{ e.Broadcast }}){% unless forloop.last %}, {% endunless -%}
      {% endfor %}
      ]
    )
{   
    {% for cmd in Commands -%}
        public async Task {{ cmd.MethodName }} ({{ cmd.ClrTypeName }} command)
        {       
          {% if cmd.ReturnsEvents %}var cmdResult = {% endif %}await commandDispatcher.Handle(command);
          {% if cmd.ReturnsEvents %}
          await SendEvents(cmdResult.Messages);
          {%- endif %}
        }
    {% endfor %}
    {%- for q in Queries %}
        public async Task {{ q.MethodName }}({{ q.ClrTypeName }} query) 
        {
            var result = await queryProcessor.Query(query);
            await SendQueryResultReply("{{ q.MethodName }}", result);
        }
    {% endfor %}
}